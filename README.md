# Цифровой кукольный театр

Приложение для автоматической генерации анимации по заданному в JSON формате сценарию. Программа получает на вход исходники изображений, файлы шрифтов, а также JSON файл, результатом обработки сценария является мультфильм, стилизованный под театральное представление.

Проект реализовн на языке Python с использованием библиотек OpenCV, Pillow и MoviePy.

Список автоматизированных действий:

1. Выборка изображений и их предобработка (удаление простого фона)
2. Аффинные преобразования изображений
3. Позиционирование изображения объекта в сцене
4. Движение объекта с заданными параметрами
5. Наложение эффектов на изображение объекта
6. Создание общего клипа сцены
7. Наложение на клип сцены выбранных эффектов
8. Создание субтитров сцены
9. Компиляция сцен в итоговое видео и его сохранение

## Установка

```bash
git clone https://github.com/aniglovilui/doll-theatre.git
cd doll-theatre
pip install -r requirements.txt
```

## Входные данные

Все исходники изображений загружаются пользователем самостоятельно в папку sources/ в корне проекта.

### 1. Исходники изображений

Изображения персонажей добавляются в подпапку sources/images/characters/, предметов - в sources/images/props/, фонов - в sources/images/backgrounds/.

### 2. Исходники шрифтов

Файлы шрифтов .ttf должны находится в папке sources/fonts/

### 3. JSON файлы сценариев

Файлы сценариев помещаются в папку scanarios/ в корне проекта.

## Запуск

```bash
python3 main.py
```

Для демонстрации работы программы в консоль после вывода `Введите имя файла без расширения:` необходимо ввести `scenario_test`, в файле scenario_test.json содержаться первые две сцены демонстрационного мультфильма. Полностью демонстрационного мультфильм может быть воссоздан при вводе `happieness_in_a_box` в качестве названия файла и найден с аналогичным именем в performances/.

Для более удобной сборке мультфильма возможно использование тестового режима. Выбор тестового режима осуществляется путем ввода "y" на вопрос `Включить тестовый режим? [y/n]:`. Он подразумевает возможность выбора конкретных сцен, которые необходимо зарендерить, а также ограничения их по времени для сверки композиции.

## Шаблон JSON сценария

Сценарий имеет следующую многоуровневую структуру (данные вставлены для наглядности).

```JSON
{
    "scenario_name": "Scenario Name",
    "movie_sizes": [1280, 720],
    "main_font": {
        "font_name": "font-name.ttf",
        "font_size": 36,
        "font_color": "#ffffff",
        "stroke_color": "#000000",
        "stroke_width": 2
    },
    "accent_font": {
        "font_name": " font-name.ttf",
        "font_size": 36,
        "font_color": "#aabbcc",
        "stroke_color": "#000000",
        "stroke_width": 2
    },
    "scenes": [
        {
            "index": 1,
            "description": "Scene description.",
            "duration": 7.0,
            "background": "background.png",
            "lines": [
                {
                    "character": "Character name",
                    "text": "Text.",
                    "font": {
                        "font_size": 120,
                        "font_color": "#ebc354",
                        "stroke_color": "#1a100b",
                        "stroke_width": 2
                    },
                    "appearing_time": 0.0,
                    "time": 5.3,
                }, {…}
            ],
            "composition": [
                {
                    "category": "characters",
                    "image_name": "character1.png",
                    "z-index": 1,
                    "scale": 1.1,
                    "rotation_angle": 0,
                    "coordinates": [0.51, 0.13],
                    "reflection": false,
                    "opacity": 0.5,
                    "motion": {
                        "motion_type": "linear",
                        "starting_time": 3.2,
                        "motion_time": 4.1,
                        "params": {
                            "speed": [0, 10]
                        }
                    },
                    "effect": [
                        {
                        "effect_type": "appearance",
                        "effect_appearance_time": 3.2,
                        "effect_duration": 1.0
                        },
                        {
                        "effect_type": "disappearance",
                        "effect_appearance_time": 6.3,
                        "effect_duration": 1.0
                        }
                    ]
                }, {…}
            ],
            "scene_effect": [
                {
                    "effect_type": "scene_fade_out",
                    "effect_appearance_time": 5.3,
                    "effect_duration": 1.0,
                    "fade_color": [0, 0, 0]
                }
            ]
        }, {…}
    ]
}

```

### Описание полей

Глобальные параметры

- scenario_name (string) – Определяет название сценария.
- movie_sizes (array) – Размеры выходного видео в пикселях, записанные в формате [ширина, высота].

Стили текста

Шрифтовые стили унифицируются через объекты main_font, используемый для стилизации слов автора или рассказчика, и accent_font, используемый по умолчанию для реплик всех остальных персонажей. Разделение на основной и акцентный шрифты позволяет задать разные стили для основного текста и акцентных элементов, сокращая дублирование в описании сцен. Оба параметра являются опциональными: при их отсутствии, а также при отсутствии какого-либо из их полей, для определения пропущенных свойств используются значения по умолчанию.

Каждый объект шрифта включает следующие свойства:

- font_name (string) – Имя файла шрифта trueType.
- font_size (int) – Размер шрифта.
- font_color (srting) – Цвет текста в HEX.
- stroke_color (string) – Цвет обводки текста в HEX.
- stroke_width (int) – Толщина обводки.

Массив сцен (scenes)

Представляет собой массив объектов, каждый из которых описывает одну сцену мультфильма, при этом каждая сцена является самостоятельным блоком. Сцена характеризуется следующими параметрами:

- index (int) – Порядковый номер сцены в сценарии.
- description (string, optional) – Текстовое описание сцены для удобства автора.
- duration (float) – Общая длительность сцены в секундах.
- background (string) – Имя файла фонового изображения для сцены.

Визуальное и временное наполнение сцены разделено на два смысловых блока: список реплик lines (array), описывающих текстовые реплики в сцене, и композицию composition (array).
Список реплик (lines) представляет собой массив объектов, имеющих параметры:

- character (string) – Имя персонажа, произносящего реплику.
- text (string) – Текст реплики.
- font (object, optional) – Локальный стиль текста для реплики. Позволяет переопределить глобальные main_font или accent_font или их отдельные поля для конкретной реплики, вследствие этого содержит те же поля (font_size, font_color и т.д.). Отсутствующие поля наследуются из глобального стиля.
- appearing_time (float, optional) – Время появления реплики на экране относительно начала сцены, в секундах. Поле может быть опущено, при отсутствии автоматически рассчитывается по времени появления и длительности прошлой реплики. При отсутствии параметра во всех репликах сцены реплики будут идти друг за другом, начиная с времени 0.0.
- time (float) – Время нахождения реплики на экране относительно времени появления реплики, в секундах.

Список используемых в сцене визуальных элементов composition представляет собой массив объектов с параметрами:

- category (string) – Категория элемента. Значение может быть одним из вариантов: "characters", "props".
- image_name (string) – Имя файла изображения элемента.
- z-index (int) – Уровень слоя. Определяет порядок отрисовки, при котором элементы с большим значением рисуются поверх.
- scale (float, optional) – Масштаб элемента. Значение, равное 1.0, соответствует масштабы 100%. По умолчанию равен 100%.
- rotation_angle (float, optional) – Угол поворота элемента в градусах. По умолчанию равен 0.
- coordinates (array) – Координаты позиции элемента относительно размеров видео в формате [x, y], где [0.0, 0.0] соответствует левому верхнему углу фонового изображения, [1.0, 1.0] – правому нижнему. Позволяет независимо позиционировать элементы при разных размерах видео. При желании возможно указание координат не в относительном формате, а в пикселях.
- reflection (boolean, optional) – Флаг наличия зеркального отображения элемента по горизонтали. По умолчанию отображение отсутствует.
- opacity (floatt, optional) – Непрозрачность элемента. Значение находится в диапазоне от 0 до 1. По умолчанию элемент является полностью непрозрачным, что соответствует значению 1.
- motion (object, optional) – Объект, описывающий анимацию перемещения элемента. При отсутствии параметра движение не реализуется. Подробнее будет описан далее.
- effect (objectt, optional) – Массив объектов, описывающих эффекты, применяемые к элементу (появление, исчезновение и т.д.). При отсутствии параметра эффекты не реализуются. Подробнее будет описан далее.

Динамика элементов описывается в объекте motion, объекты которого имеют свойства:

- motion_type (string) – Тип движения. При отсутствии движения может быть указан как "none".
- starting_time (float, optional) – Время начала движения относительно начала сцены, сек. По умолчанию принимается значение 0.0 – начало сцены.
- motion_time (float, optional) – Длительность движения, сек. При отсутствии указания параметра движение происходит до конца сцены.
- start (array, optional) – Координаты начала движения. Обычно не указываются, так как по умолчанию движения начинается от координат позиционирования элемента, которые являются параметром, обязательным для указания.
- params (object) – Параметры движения. Структура зависит от необходимого типа движения. Для реализации вращения вокруг центра объекта необходим параметр angle_speed: вектор угловой скорости omega, измеряемый в градусах в секунду. Для равноускоренного линейного движения – параметр speed: вектор линейной скорости [vx, vy] в пикселях в секунду. Для движения с ускорением (параболическая траектория) – параметр speed может быть опущен, а может быть скомбинирован с параметром acceleration, представляющий вектор ускорения [ax, ay]. Возможно комбинирование всех трех параметров, тогда объект будет двигаться по параболической траектории с вращением вокруг центра. Возможно указание параметра stop, содержащего координаты окончания движения. В таком случае движение автоматически считается линейным равноускоренным, и компоненты скорости рассчитываются как частное смещение по соответствующей оси и времени движения.

Эффекты элемента описаны в массиве effect. Эффекты накладываются на изображение объекта в порядке их следования в массиве. Каждый эффект имеет свойства:

- effect_type (string) – Тип эффекта. Один из вариантов: "appearance", "disappearance", "none", соответствующих плавному появлению и плавному исчезновению изображения объекта в изображении сцены. При значении, равном "none", эффект не накладывается.
- effect_appearance_time (float, optional) – Время начала эффекта относительно начала сцены в секундах. По умолчанию начинается с 0.0.
- effect_duration (float, optional) – Длительность эффекта в секундах. По умолчанию равен 0.5 секунды.

Общие эффекты сцены массива scene_effect применяются ко всему кадру, в порядке их следования в массиве. Поле scene_effect является свойством объекта scene. Примером эффекта сцены является плавное затемнение с указанием цвета и параметрами времени.

Параметры эффекта сцены аналогичны параметрам эффектов элемента (effect_type, effect_appearance_time, effect_duration), за исключение необходимости наличия параметра fade_color (array) – цвета затухания или появления в формате [R, G, B]. Параметр effect_type должен иметь одно из значений: "scene_fade_in", "scene_fade_out", "scene_flash". При указании "scene_fade_in" возможно также добавление поля in_the_op (bool) со значением true, сигнализирующее о необходимости начинать сцену с высветления из заданного цвета. При указании "scene_fade_out" возможно добавление поля in_the_end (bool) со значением true, сигнализирующее о необходимости заканчивать сцену затемнением в заданный цвет. При указании scene_flash (bool) со значением true, эффект происходит в середине сцены и выглядит как вспышка, которая является последовательной комбинацией эффекта затемнения в выбранный цвет и высветления из него.

## Источники

- Реализация алгоритма удаления фона на изображении основана на статье:
  [Простой фильтр для автоматического удаления фона с изображений] ([ArXen42])
  https://habr.com/ru/articles/353890/
